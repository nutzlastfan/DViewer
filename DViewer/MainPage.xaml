<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="DViewer.MainPage"
    x:Name="This"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
    xmlns:local="clr-namespace:DViewer"
    xmlns:controls="clr-namespace:DViewer.Controls"
    Title="DICOM Vergleich"
    Padding="10"
    NavigationPage.HasNavigationBar="False">

    <ContentPage.Resources>
        <ResourceDictionary>
            <local:DoubleToGridLengthConverter x:Key="StarConverter" />
            <local:AlternateBackgroundConverter x:Key="AltBgConverter" />
            <local:FormatDateDisplayConverter x:Key="FormatDateDisplay" />
            <local:FormatTimeDisplayConverter x:Key="FormatTimeDisplay" />
            <local:NullableDateConverter x:Key="NullableDateConverter" />
            <local:NullableTimeConverter x:Key="NullableTimeConverter" />
            <local:OnlyWhenFocusedConverter x:Key="OnlyWhenFocusedConverter" />

            <Style x:Key="CellEntry" TargetType="Entry">
                <Setter Property="Margin" Value="2,0"/>
                <Setter Property="HeightRequest" Value="36"/>
                <Setter Property="ClearButtonVisibility" Value="WhileEditing"/>
                <Setter Property="BackgroundColor" Value="{AppThemeBinding Light=#FFFFFFFF, Dark=#1E1E1E}"/>
                <Setter Property="TextColor" Value="{AppThemeBinding Light=#111111, Dark=#EEEEEE}"/>
                <Setter Property="PlaceholderColor" Value="{AppThemeBinding Light=#888888, Dark=#888888}"/>
            </Style>

            <Style x:Key="FabSmall" TargetType="Button">
                <Setter Property="WidthRequest" Value="36"/>
                <Setter Property="HeightRequest" Value="36"/>
                <Setter Property="CornerRadius" Value="18"/>
                <Setter Property="BackgroundColor" Value="{AppThemeBinding Light=#6A5ACD, Dark=#4C6A5ACD}"/>
                <Setter Property="TextColor" Value="White"/>
                <Setter Property="FontAttributes" Value="Bold"/>
                <Setter Property="Padding" Value="0"/>
            </Style>
        </ResourceDictionary>
    </ContentPage.Resources>

    <!-- Reihen: 0 Bilder (mit Overlay), 1 Filter, 2 Haupttabelle -->
    <Grid RowDefinitions="Auto,Auto,*" ColumnDefinitions="*">

        <!-- 0) Viewer (links/rechts) -->
        <!-- 0) Viewer (links/rechts) -->
        <Grid Grid.Row="0" ColumnDefinitions="*,*" ColumnSpacing="8">

            <!-- LINKS -->
            <Frame Grid.Column="0" HasShadow="True" CornerRadius="6" Padding="0">
                <Grid>
                    <!-- Viewer zuerst -->
                    <controls:DicomViewerView x:Name="LeftViewer" HeightRequest="500"
                                                  Item="{Binding Left}"
    VideoSource="{Binding LeftVideoSource}"
    FrameIndex="{Binding LeftFrameIndex, Mode=TwoWay}"
                                      HasVideo="{Binding LeftHasVideo}"
                                      PrevFrameCommand="{Binding LeftPrevFrameCommand}"
                                      NextFrameCommand="{Binding LeftNextFrameCommand}"
                                      PlayPauseCommand="{Binding LeftPlayPauseCommand}"
                                      IsPlaying="{Binding LeftIsPlaying}"
                                      PatientNameWithSex="{Binding LeftPatientNameWithSex}"
                                      Species="{Binding LeftSpecies}"
                                      PatientID="{Binding LeftPatientID}"
                                      BirthDateDisplay="{Binding LeftBirthDateDisplay}"
                                      OtherPid="{Binding LeftOtherPid}" />

                    <!-- L-Button oben darüber legen -->
                    <Button Text="L"
                    CornerRadius="18" WidthRequest="36" HeightRequest="36"
                    FontAttributes="Bold" ZIndex="20"
                    HorizontalOptions="Start" VerticalOptions="Center" Margin="8"
                    Clicked="OnOpenLeftClicked"/>
                </Grid>
            </Frame>

            <!-- RECHTS -->
            <Frame Grid.Column="1" HasShadow="True" CornerRadius="6" Padding="0">
                <Grid>
                    <controls:DicomViewerView x:Name="RightViewer" HeightRequest="500"
                                      Item="{Binding Right}"
                                      HasVideo="{Binding RightHasVideo}"
                                      VideoSource="{Binding RightVideoSource}"
                                      FrameIndex="{Binding RightFrameIndex, Mode=TwoWay}"
                                      PrevFrameCommand="{Binding RightPrevFrameCommand}"
                                      NextFrameCommand="{Binding RightNextFrameCommand}"
                                      PlayPauseCommand="{Binding RightPlayPauseCommand}"
                                      IsPlaying="{Binding RightIsPlaying}"
                                      PatientNameWithSex="{Binding RightPatientNameWithSex}"
                                      Species="{Binding RightSpecies}"
                                      PatientID="{Binding RightPatientID}"
                                      BirthDateDisplay="{Binding RightBirthDateDisplay}"
                                      OtherPid="{Binding RightOtherPid}" />

                    <Button Text="R"
                    CornerRadius="18" WidthRequest="36" HeightRequest="36"
                    FontAttributes="Bold" ZIndex="20"
                    HorizontalOptions="Start" VerticalOptions="Center" Margin="8"
                    Clicked="OnOpenRightClicked"/>
                </Grid>
            </Frame>
        </Grid>
        <!-- 1) Optionen / Filter -->
        <Frame Grid.Row="1" HasShadow="True" CornerRadius="6" Padding="8">
            <Grid ColumnDefinitions="Auto,*,Auto,Auto,Auto,Auto,Auto" ColumnSpacing="10" RowDefinitions="Auto,Auto" RowSpacing="6">
                <Label Grid.Column="0" Text="Filter:" VerticalTextAlignment="Center" />
                <Entry Grid.Column="1" Placeholder="Tag, Name oder Wert(e) suchen…" Text="{Binding FilterText, Mode=TwoWay}" />
                <Label Grid.Column="2" Text="Nur Unterschiede" VerticalTextAlignment="Center" />
                <Switch Grid.Column="3" IsToggled="{Binding ShowOnlyDifferences, Mode=TwoWay}" />
                <Label Grid.Column="4" Text="Nur ungültige" VerticalTextAlignment="Center" />
                <Switch Grid.Column="5" IsToggled="{Binding ShowOnlyInvalid, Mode=TwoWay}" />
            </Grid>
        </Frame>

        <!-- 2) Haupt-Bereich -->
        <Grid Grid.Row="2" ColumnDefinitions="2*,5*" ColumnSpacing="8" RowDefinitions="*">

            <!-- Tags (links) -->
            <Frame Grid.Column="0" HasShadow="True" CornerRadius="6" Padding="0">
                <Grid RowDefinitions="Auto,*">
                    <Grid RowDefinitions="Auto" Padding="8" BackgroundColor="#2D2D2D">
                        <Grid Grid.Row="1" Grid.ColumnSpan="7" ColumnDefinitions="Auto,*,Auto" ColumnSpacing="8">
                            <Label Grid.Column="0" Text="Tag-Filter:" VerticalTextAlignment="Center" />
                            <Entry Grid.Column="1" Placeholder="(0010,0010) PatientName …" Text="{Binding TagSearchText, Mode=TwoWay}" />
                            <Button Grid.Column="2" Text="Tag-Filter löschen" Clicked="OnClearTagFilterClicked" />
                        </Grid>
                    </Grid>

                    <CollectionView Grid.Row="1"
                                    ItemsSource="{Binding FilteredTagFilters}"
                                    SelectionMode="Single"
                                    SelectionChanged="OnTagFilterSelectionChanged">
                        <CollectionView.ItemTemplate>
                            <DataTemplate>
                                <Grid Padding="8" ColumnDefinitions="Auto,*" ColumnSpacing="8">
                                    <Label Text="{Binding TagId}" FontAttributes="Bold" />
                                    <Label Grid.Column="1" Text="{Binding Name}" />
                                </Grid>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>
                </Grid>
            </Frame>

            <!-- Vergleich (rechts) -->
            <Frame Grid.Column="1" HasShadow="True" CornerRadius="6" Padding="0">
                <Grid RowDefinitions="Auto,*" ColumnSpacing="8">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="{Binding TagWidth,  Converter={StaticResource StarConverter}}"/>
                        <ColumnDefinition Width="{Binding NameWidth, Converter={StaticResource StarConverter}}"/>
                        <ColumnDefinition Width="{Binding LeftWidth, Converter={StaticResource StarConverter}}"/>
                        <ColumnDefinition Width="{Binding RightWidth,Converter={StaticResource StarConverter}}"/>
                    </Grid.ColumnDefinitions>

                    <Button Grid.Row="0" Grid.Column="0" Text="{Binding TagHeaderText}"
                            Clicked="OnSortClicked" CommandParameter="TagId" TextColor="White" />
                    <Button Grid.Row="0" Grid.Column="1" Text="{Binding NameHeaderText}"
                            Clicked="OnSortClicked" CommandParameter="Name" TextColor="White" />
                    <Button Grid.Row="0" Grid.Column="2" Text="{Binding LeftHeaderText}"
                            Clicked="OnSortClicked" CommandParameter="LeftValue" TextColor="White" />
                    <Button Grid.Row="0" Grid.Column="3" Text="{Binding RightHeaderText}"
                            Clicked="OnSortClicked" CommandParameter="RightValue" TextColor="White" />

                    <CollectionView Grid.Row="1" Grid.ColumnSpan="4"
                                    ItemsSource="{Binding FilteredItems}"
                                    SelectionMode="Single"
                                    SelectionChanged="OnCombinedSelectionChanged">
                        <CollectionView.ItemTemplate>
                            <DataTemplate>
                                <Grid Padding="4" BackgroundColor="{Binding IsAlternate, Converter={StaticResource AltBgConverter}}">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="{Binding BindingContext.TagWidth,  Source={x:Reference This}, Converter={StaticResource StarConverter}}"/>
                                        <ColumnDefinition Width="{Binding BindingContext.NameWidth, Source={x:Reference This}, Converter={StaticResource StarConverter}}"/>
                                        <ColumnDefinition Width="{Binding BindingContext.LeftWidth, Source={x:Reference This}, Converter={StaticResource StarConverter}}"/>
                                        <ColumnDefinition Width="{Binding BindingContext.RightWidth,Source={x:Reference This}, Converter={StaticResource StarConverter}}"/>
                                    </Grid.ColumnDefinitions>

                                    <Label Grid.Column="0" Text="{Binding TagId}" VerticalTextAlignment="Center" FontAttributes="Bold" Margin="4,0"/>
                                    <Label Grid.Column="1" Text="{Binding Name}" VerticalTextAlignment="Center" LineBreakMode="TailTruncation" Margin="4,0"/>

                                    <Entry x:Name="LeftValueEntry" Grid.Column="2" Margin="2,0"
                                           Text="{Binding LeftText, Mode=TwoWay,
                                                  Converter={StaticResource OnlyWhenFocusedConverter},
                                                  ConverterParameter={Binding Source={x:Reference LeftValueEntry}, Path=IsFocused}}"/>

                                    <Entry x:Name="RightValueEntry" Grid.Column="3" Margin="2,0"
                                           Text="{Binding RightText, Mode=TwoWay,
                                                  Converter={StaticResource OnlyWhenFocusedConverter},
                                                  ConverterParameter={Binding Source={x:Reference RightValueEntry}, Path=IsFocused}}"/>
                                </Grid>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>

                    <!-- OVERLAYS -->
                    <Button Grid.Row="0" Grid.RowSpan="2" Grid.Column="2" ZIndex="10"
                            Style="{StaticResource FabSmall}" Text="+" Margin="0,0,02,0"
                            HorizontalOptions="End" VerticalOptions="Start"
                            AutomationProperties.Name="Tag zu LINKS hinzufügen"
                            Clicked="OnAddTagLeftOverlayClicked"/>
                    <Button Grid.Row="0" Grid.RowSpan="2" Grid.Column="2" ZIndex="10"
                            Style="{StaticResource FabSmall}" Text="💾" Margin="0,0,50,0"
                            HorizontalOptions="End" VerticalOptions="Start"
                            AutomationProperties.Name="LINKS speichern"
                            Clicked="OnSaveLeftClicked"/>

                    <Button Grid.Row="0" Grid.RowSpan="2" Grid.Column="3" ZIndex="10"
                            Style="{StaticResource FabSmall}" Text="+" Margin="0,0,02,0"
                            HorizontalOptions="End" VerticalOptions="Start"
                            AutomationProperties.Name="Tag zu RECHTS hinzufügen"
                            Clicked="OnAddTagRightOverlayClicked"/>
                    <Button Grid.Row="0" Grid.RowSpan="2" Grid.Column="3" ZIndex="10"
                            Style="{StaticResource FabSmall}" Text="💾" Margin="0,0,50,0"
                            HorizontalOptions="End" VerticalOptions="Start"
                            AutomationProperties.Name="RECHTS speichern"
                            Clicked="OnSaveRightClicked"/>
                </Grid>
            </Frame>
        </Grid>

        <!-- Vollbild Overlay: Links -->
        <Grid Grid.RowSpan="3"
              IsVisible="{Binding Source={x:Reference This}, Path=LeftFullscreenVisible}"
              BackgroundColor="#CC000000">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>

            <Grid Grid.Row="0" Padding="8" BackgroundColor="#1A1A1A">
                <Button Text="✕ Schließen" HorizontalOptions="End" Clicked="OnCloseLeftFullscreen"/>
            </Grid>

            <controls:DicomViewerView x:Name="LeftViewerFull"
                                      Grid.Row="1"
                                      Item="{Binding Left}"
                                      HasVideo="{Binding LeftHasVideo}"
                                      HasMultiFrame="{Binding LeftHasMultiFrame}"
                                      VideoSource="{Binding LeftVideoSource}"
                                      FrameIndex="{Binding LeftFrameIndex, Mode=TwoWay}"
                                      PrevFrameCommand="{Binding LeftPrevFrameCommand}"
                                      NextFrameCommand="{Binding LeftNextFrameCommand}"
                                      PlayPauseCommand="{Binding LeftPlayPauseCommand}"
                                      IsPlaying="{Binding LeftIsPlaying}"
                                      PatientNameWithSex="{Binding LeftPatientNameWithSex}"
                                      Species="{Binding LeftSpecies}"
                                      PatientID="{Binding LeftPatientID}"
                                      BirthDateDisplay="{Binding LeftBirthDateDisplay}"
                                      OtherPid="{Binding LeftOtherPid}" />
        </Grid>

        <!-- Vollbild Overlay: Rechts -->
        <Grid Grid.RowSpan="3"
              IsVisible="{Binding Source={x:Reference This}, Path=RightFullscreenVisible}"
              BackgroundColor="#CC000000">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>

            <Grid Grid.Row="0" Padding="8" BackgroundColor="#1A1A1A">
                <Button Text="✕ Schließen" HorizontalOptions="End" Clicked="OnCloseRightFullscreen"/>
            </Grid>

            <controls:DicomViewerView x:Name="RightViewerFull"
                                      Grid.Row="1"
                                      Item="{Binding Right}"
                                      HasVideo="{Binding RightHasVideo}"
                                      HasMultiFrame="{Binding RightHasMultiFrame}"
                                      VideoSource="{Binding RightVideoSource}"
                                      FrameIndex="{Binding RightFrameIndex, Mode=TwoWay}"
                                      PrevFrameCommand="{Binding RightPrevFrameCommand}"
                                      NextFrameCommand="{Binding RightNextFrameCommand}"
                                      PlayPauseCommand="{Binding RightPlayPauseCommand}"
                                      IsPlaying="{Binding RightIsPlaying}"
                                      PatientNameWithSex="{Binding RightPatientNameWithSex}"
                                      Species="{Binding RightSpecies}"
                                      PatientID="{Binding RightPatientID}"
                                      BirthDateDisplay="{Binding RightBirthDateDisplay}"
                                      OtherPid="{Binding RightOtherPid}" />
        </Grid>

    </Grid>
</ContentPage>
