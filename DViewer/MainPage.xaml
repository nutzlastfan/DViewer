<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
    xmlns:local="clr-namespace:DViewer"
    x:Class="DViewer.MainPage"
    Title="DICOM Vergleich"
    Padding="10"
    NavigationPage.HasNavigationBar="False"
    x:Name="RootPage">

    <ContentPage.Resources>
        <ResourceDictionary>
            <local:DoubleToGridLengthConverter x:Key="StarConverter" />
            <local:AlternateBackgroundConverter x:Key="AltBgConverter" />
            <local:FormatDateDisplayConverter x:Key="FormatDateDisplay" />
            <local:FormatTimeDisplayConverter x:Key="FormatTimeDisplay" />
            <local:NullableDateConverter x:Key="NullableDateConverter" />
            <local:NullableTimeConverter x:Key="NullableTimeConverter" />
            <local:OnlyWhenFocusedConverter x:Key="OnlyWhenFocusedConverter" />

            <Style x:Key="CellEntry" TargetType="Entry">
                <Setter Property="Margin" Value="2,0"/>
                <Setter Property="HeightRequest" Value="36"/>
                <Setter Property="ClearButtonVisibility" Value="WhileEditing"/>
                <Setter Property="BackgroundColor" Value="{AppThemeBinding Light=#FFFFFFFF, Dark=#1E1E1E}"/>
                <Setter Property="TextColor" Value="{AppThemeBinding Light=#111111, Dark=#EEEEEE}"/>
                <Setter Property="PlaceholderColor" Value="{AppThemeBinding Light=#888888, Dark=#888888}"/>
            </Style>

            <!-- kleiner runder FAB -->
            <Style x:Key="FabSmall" TargetType="Button">
                <Setter Property="WidthRequest" Value="36"/>
                <Setter Property="HeightRequest" Value="36"/>
                <Setter Property="CornerRadius" Value="18"/>
                <Setter Property="BackgroundColor" Value="{AppThemeBinding Light=#6A5ACD, Dark=#4C6A5ACD}"/>
                <Setter Property="TextColor" Value="White"/>
                <Setter Property="FontAttributes" Value="Bold"/>
                <Setter Property="Padding" Value="0"/>
            </Style>
        </ResourceDictionary>
    </ContentPage.Resources>

    <!-- Reihen: 0 Bilder (mit Overlay), 1 Filter, 2 Haupttabelle -->
    <Grid RowDefinitions="Auto,Auto,*" ColumnDefinitions="*">

        <!-- 0) Vorschaubilder mit Overlays -->
        <Grid Grid.Row="0" ColumnDefinitions="*,*" ColumnSpacing="8">

            <!-- LINKS -->
            <Frame Grid.Column="0" HasShadow="True" CornerRadius="6" Padding="0">
                <Grid>
             
                    <!-- Bild nur wenn kein Video -->
                    <Image HeightRequest="500" IsVisible="{Binding LeftHasVideo, Converter={StaticResource InverseBoolConverter}}"
         Source="{Binding Left.Image}" Aspect="AspectFit">
                                              <Image.GestureRecognizers>
                            <TapGestureRecognizer Tapped="OnLeftPreviewTapped" />
                        </Image.GestureRecognizers>
                    </Image>

                    <!-- Video nur wenn vorhanden -->
                    <toolkit:MediaElement HeightRequest="500" IsVisible="{Binding LeftHasVideo}"
                Source="{Binding LeftVideoSource}"
                 ShouldAutoPlay="True" ShouldShowPlaybackControls="True" />

                    <!-- Multiframe-Steuerleiste -->
                    <Grid IsVisible="{Binding LeftHasMultiFrame}" Padding="8" VerticalOptions="End">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        <Button Text="⏮" Command="{Binding LeftPrevFrameCommand}" />
                        <Slider Grid.Column="1"
            Minimum="0" Maximum="{Binding LeftFrameCount, Converter={StaticResource MinusOneConverter}}"
            Value="{Binding LeftFrameIndex, Mode=TwoWay}"/>
                        <Button Grid.Column="2" Text="⏭" Command="{Binding LeftNextFrameCommand}" />
                        <Button Grid.Column="3" Text="{Binding LeftIsPlaying, Converter={StaticResource PlayPauseTextConverter}}"
            Command="{Binding LeftPlayPauseCommand}"/>
                    </Grid>


                    <!-- runder L-Button oben links -->
                    <Button Text="L"
                            CornerRadius="18" WidthRequest="36" HeightRequest="36"
                            FontAttributes="Bold"
                            HorizontalOptions="Start" VerticalOptions="Start" Margin="8"
                            Clicked="OnOpenLeftClicked"/>

                    <!-- Text-Overlay -->
                    <Grid HorizontalOptions="Start" VerticalOptions="Start"
                          Margin="56,8,8,8" Padding="8"
                          BackgroundColor="#66000000" MaximumWidthRequest="600" InputTransparent="True">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>

                        <!-- Patient (mit Sex) -->
                        <Label Grid.Row="0"
                               Text="{Binding LeftPatientNameWithSex}"
                               FontAttributes="Bold" TextColor="White"
                               LineBreakMode="TailTruncation" MaxLines="1"/>

                        <!-- Species / Breed -->
                        <Grid Grid.Row="1" ColumnDefinitions="Auto,*" ColumnSpacing="6">
                            <Label Grid.Column="0" Text="Species" FontAttributes="Italic" TextColor="#DDFFFFFF"/>
                            <Label Grid.Column="1" Text="{Binding LeftSpecies}" TextColor="White"
                                   LineBreakMode="TailTruncation" MaxLines="1"/>
                        </Grid>

                        <!-- PID -->
                        <Grid Grid.Row="2" ColumnDefinitions="Auto,*" ColumnSpacing="6">
                            <Label Grid.Column="0" Text="PID" FontAttributes="Italic" TextColor="#DDFFFFFF"/>
                            <Label Grid.Column="1" Text="{Binding LeftPatientID}" TextColor="White"
                                   LineBreakMode="TailTruncation" MaxLines="1"/>
                        </Grid>

                        <!-- DOB -->
                        <Grid Grid.Row="3" ColumnDefinitions="Auto,*" ColumnSpacing="6">
                            <Label Grid.Column="0" Text="DOB" FontAttributes="Italic" TextColor="#DDFFFFFF"/>
                            <Label Grid.Column="1" Text="{Binding LeftBirthDateDisplay}" TextColor="White"/>
                        </Grid>

                        <!-- Other PID -->
                        <Grid Grid.Row="4" ColumnDefinitions="Auto,*" ColumnSpacing="6">
                            <Label Grid.Column="0" Text="Other PID" FontAttributes="Italic" TextColor="#DDFFFFFF"/>
                            <Label Grid.Column="1" Text="{Binding LeftOtherPid}" TextColor="White"
                                   LineBreakMode="TailTruncation" MaxLines="1"/>
                        </Grid>
                    </Grid>
                </Grid>
            </Frame>

            <!-- RECHTS -->
            <Frame Grid.Column="1" HasShadow="True" CornerRadius="6" Padding="0">
                <Grid>
                    <Image Source="{Binding Right.Image}" Aspect="AspectFit" HeightRequest="500">
                        <Image.GestureRecognizers>
                            <TapGestureRecognizer Tapped="OnRightPreviewTapped" />
                        </Image.GestureRecognizers>
                    </Image>

                    <Button Text="R"
                            CornerRadius="18" WidthRequest="36" HeightRequest="36"
                            FontAttributes="Bold"
                            HorizontalOptions="Start" VerticalOptions="Start" Margin="8"
                            Clicked="OnOpenRightClicked"/>

                    <Grid HorizontalOptions="Start" VerticalOptions="Start"
                          Margin="56,8,8,8" Padding="8"
                          BackgroundColor="#66000000" MaximumWidthRequest="600">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>

                        <Label Grid.Row="0"
                               Text="{Binding RightPatientNameWithSex}"
                               FontAttributes="Bold" TextColor="White"
                               LineBreakMode="TailTruncation" MaxLines="1"/>

                        <Grid Grid.Row="1" ColumnDefinitions="Auto,*" ColumnSpacing="6">
                            <Label Grid.Column="0" Text="Species" FontAttributes="Italic" TextColor="#DDFFFFFF"/>
                            <Label Grid.Column="1" Text="{Binding RightSpecies}" TextColor="White"
                                   LineBreakMode="TailTruncation" MaxLines="1"/>
                        </Grid>

                        <Grid Grid.Row="2" ColumnDefinitions="Auto,*" ColumnSpacing="6">
                            <Label Grid.Column="0" Text="PID" FontAttributes="Italic" TextColor="#DDFFFFFF"/>
                            <Label Grid.Column="1" Text="{Binding RightPatientID}" TextColor="White"
                                   LineBreakMode="TailTruncation" MaxLines="1"/>
                        </Grid>

                        <Grid Grid.Row="3" ColumnDefinitions="Auto,*" ColumnSpacing="6">
                            <Label Grid.Column="0" Text="DOB" FontAttributes="Italic" TextColor="#DDFFFFFF"/>
                            <Label Grid.Column="1" Text="{Binding RightBirthDateDisplay}" TextColor="White"/>
                        </Grid>

                        <Grid Grid.Row="4" ColumnDefinitions="Auto,*" ColumnSpacing="6">
                            <Label Grid.Column="0" Text="Other PID" FontAttributes="Italic" TextColor="#DDFFFFFF"/>
                            <Label Grid.Column="1" Text="{Binding RightOtherPid}" TextColor="White"
                                   LineBreakMode="TailTruncation" MaxLines="1"/>
                        </Grid>
                    </Grid>
                </Grid>
            </Frame>
        </Grid>

        <!-- 1) Optionen / Filter -->
        <Frame Grid.Row="1" HasShadow="True" CornerRadius="6" Padding="8">
            <Grid ColumnDefinitions="Auto,*,Auto,Auto,Auto,Auto,Auto" ColumnSpacing="10" RowDefinitions="Auto,Auto" RowSpacing="6">
                <Label Grid.Column="0" Text="Filter:" VerticalTextAlignment="Center" />
                <Entry Grid.Column="1" Placeholder="Tag, Name oder Wert(e) suchen…" Text="{Binding FilterText, Mode=TwoWay}" />
                <Label Grid.Column="2" Text="Nur Unterschiede" VerticalTextAlignment="Center" />
                <Switch Grid.Column="3" IsToggled="{Binding ShowOnlyDifferences, Mode=TwoWay}" />
                <Label Grid.Column="4" Text="Nur ungültige" VerticalTextAlignment="Center" />
                <Switch Grid.Column="5" IsToggled="{Binding ShowOnlyInvalid, Mode=TwoWay}" />
            </Grid>
        </Frame>

        <!-- 2) Haupt-Bereich -->
        <Grid Grid.Row="2" ColumnDefinitions="2*,5*" ColumnSpacing="8" RowDefinitions="*">

            <!-- Tags (links) -->
            <Frame Grid.Column="0" HasShadow="True" CornerRadius="6" Padding="0">
                <Grid RowDefinitions="Auto,*">
                    <Grid RowDefinitions="Auto" Padding="8" BackgroundColor="#2D2D2D">
                        <Grid Grid.Row="1" Grid.ColumnSpan="7" ColumnDefinitions="Auto,*,Auto" ColumnSpacing="8">
                            <Label Grid.Column="0" Text="Tag-Filter:" VerticalTextAlignment="Center" />
                            <Entry Grid.Column="1" Placeholder="(0010,0010) PatientName …" Text="{Binding TagSearchText, Mode=TwoWay}" />
                            <Button Grid.Column="2" Text="Tag-Filter löschen" Clicked="OnClearTagFilterClicked" />
                        </Grid>
                    </Grid>

                    <CollectionView Grid.Row="1"
                                    ItemsSource="{Binding FilteredTagFilters}"
                                    SelectionMode="Single"
                                    SelectionChanged="OnTagFilterSelectionChanged">
                        <CollectionView.ItemTemplate>
                            <DataTemplate>
                                <Grid Padding="8" ColumnDefinitions="Auto,*" ColumnSpacing="8">
                                    <Label Text="{Binding TagId}" FontAttributes="Bold" />
                                    <Label Grid.Column="1" Text="{Binding Name}" />
                                </Grid>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>
                </Grid>
            </Frame>

            <!-- Vergleich (rechts) -->
            <Frame Grid.Column="1" HasShadow="True" CornerRadius="6" Padding="0">
                <Grid RowDefinitions="Auto,*">

                    <!-- Kopf: Sort-Buttons + Add(+) je Spalte (Links/Rechts) -->
                    <Grid RowDefinitions="Auto"
                          ColumnDefinitions="0.1*,0.2*,*,*"
                          Padding="8" BackgroundColor="#2D2D2D" ColumnSpacing="8">

                        <!-- Tag / Name -->
                        <Button Grid.Column="0" Text="{Binding TagHeaderText}"
                                Clicked="OnSortClicked" CommandParameter="TagId"
                                TextColor="White" />
                        <Button Grid.Column="1" Text="{Binding NameHeaderText}"
                                Clicked="OnSortClicked" CommandParameter="Name"
                                TextColor="White" />

                        <!-- Links-Header + Add -->
                        <Grid Grid.Column="2" ColumnDefinitions="*,Auto">
                            <Button Grid.Column="0" Text="{Binding LeftHeaderText}"
                                    Clicked="OnSortClicked" CommandParameter="LeftValue"
                                    TextColor="White" />
                            <Button Grid.Column="1" Style="{StaticResource FabSmall}"
                                    Text="+" Margin="8,0,0,0"
                                    AutomationProperties.Name="Tag zu LINKS hinzufügen"
                                    Clicked="OnAddTagLeftOverlayClicked" />
                        </Grid>

                        <!-- Rechts-Header + Add -->
                        <Grid Grid.Column="3" ColumnDefinitions="*,Auto">
                            <Button Grid.Column="0" Text="{Binding RightHeaderText}"
                                    Clicked="OnSortClicked" CommandParameter="RightValue"
                                    TextColor="White" />
                            <Button Grid.Column="1" Style="{StaticResource FabSmall}"
                                    Text="+" Margin="8,0,0,0"
                                    AutomationProperties.Name="Tag zu RECHTS hinzufügen"
                                    Clicked="OnAddTagRightOverlayClicked" />
                        </Grid>
                    </Grid>

                    <!-- Liste -->
                    <CollectionView Grid.Row="1"
                                    ItemsSource="{Binding FilteredItems}"
                                    SelectionMode="Single"
                                    SelectionChanged="OnCombinedSelectionChanged">
                        <CollectionView.ItemTemplate>
                            <DataTemplate>
                                <Grid Padding="4" ColumnDefinitions="0.1*,0.2*,0.4*,0.4*" RowDefinitions="Auto"
                                      BackgroundColor="{Binding IsAlternate, Converter={StaticResource AltBgConverter}}">
                                    <Label Grid.Column="0" Text="{Binding TagId}"   VerticalTextAlignment="Center" FontAttributes="Bold" Margin="4,0" />
                                    <Label Grid.Column="1" Text="{Binding Name}"    VerticalTextAlignment="Center" LineBreakMode="TailTruncation" Margin="4,0" />

                                    <!-- Links -->
                                    <Entry x:Name="LeftValueEntry" Grid.Column="2" Margin="2,0"
                                           Text="{Binding LeftText, Mode=TwoWay,
                                                  Converter={StaticResource OnlyWhenFocusedConverter},
                                                  ConverterParameter={Binding Source={x:Reference LeftValueEntry}, Path=IsFocused}}" />

                                    <!-- Rechts -->
                                    <Entry x:Name="RightValueEntry" Grid.Column="3" Margin="2,0"
                                           Text="{Binding RightText, Mode=TwoWay,
                                                  Converter={StaticResource OnlyWhenFocusedConverter},
                                                  ConverterParameter={Binding Source={x:Reference RightValueEntry}, Path=IsFocused}}" />
                                </Grid>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>

                </Grid>
            </Frame>
        </Grid>
    </Grid>
</ContentPage>
